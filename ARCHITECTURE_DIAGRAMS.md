# АРХИТЕКТУРНЫЕ ДИАГРАММЫ SELFOLOGY

## 1. ТЕКУЩАЯ АРХИТЕКТУРА (ПРОБЛЕМНАЯ)

```
┌───────────────────────────────────────────────────────────────────┐
│                    МОНОЛИТНЫЙ КОНТРОЛЛЕР                          │
│                  selfology_controller.py                          │
│                                                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  Telegram   │  │  Onboarding │  │   Analysis  │              │
│  │  Handlers   │◄─┤   Logic     │◄─┤    Logic    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                  │                     │
│         ▼                ▼                  ▼                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Profile   │  │    Coach    │  │  Monitoring │              │
│  │   Logic     │  │    Logic    │  │    Logic    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                │                  │                     │
└─────────┼────────────────┼──────────────────┼─────────────────────┘
          │                │                  │
          └────────────────┴──────────────────┘
                           ▼
          ┌────────────────────────────────────┐
          │     ЕДИНАЯ БАЗА ДАННЫХ (schema)    │
          │                                    │
          │  ┌──────────────────────────────┐  │
          │  │ users                        │  │
          │  │ onboarding_sessions          │  │
          │  │ user_answers_new             │  │
          │  │ answer_analysis              │  │
          │  │ personality_profiles         │  │
          │  │ trait_history                │  │
          │  │ questions_metadata           │  │
          │  │ chat_sessions                │  │
          │  └──────────────────────────────┘  │
          └────────────────────────────────────┘

ПРОБЛЕМЫ:
❌ Tight Coupling - все связано со всем
❌ Single Point of Failure - падение одной части = падение всего
❌ Shared Database - изменение схемы ломает все системы
❌ Нет изоляции - невозможно тестировать компоненты отдельно
❌ Сложность масштабирования - только вертикальное
```

---

## 2. ЦЕЛЕВАЯ АРХИТЕКТУРА (EVENT-DRIVEN)

```
┌────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY                                │
│                  selfology_controller.py                           │
│                    (только роутинг)                                │
└────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                         EVENT BUS                                  │
│              (Асинхронная шина событий)                            │
│                                                                    │
│  Events: UserStartedEvent, QuestionAnsweredEvent,                 │
│          AnalysisCompletedEvent, ProfileUpdatedEvent...            │
└────────────────────────────────────────────────────────────────────┘
         │              │              │              │              │
         ▼              ▼              ▼              ▼              ▼
┌──────────────┐┌──────────────┐┌──────────────┐┌──────────────┐┌────────────┐
│   TELEGRAM   ││  ONBOARDING  ││   ANALYSIS   ││   PROFILE    ││   COACH    │
│    SYSTEM    ││    SYSTEM    ││   SYSTEM     ││   SYSTEM     ││  SYSTEM    │
│              ││              ││              ││              ││            │
│ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌────────┐ │
│ │ Handlers │ ││ │ Question │ ││ │ Answer   │ ││ │ Soul     │ ││ │ Chat   │ │
│ │          │ ││ │ Router   │ ││ │ Analyzer │ ││ │Architect │ ││ │ AI     │ │
│ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └────────┘ │
│ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌────────┐ │
│ │ Messages │ ││ │ Fatigue  │ ││ │ Trait    │ ││ │ Profile  │ ││ │Context │ │
│ │ Templates│ ││ │ Detector │ ││ │Extractor │ ││ │ Builder  │ ││ │Builder │ │
│ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └────────┘ │
│ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌──────────┐ ││ ┌────────┐ │
│ │   FSM    │ ││ │ Session  │ ││ │Embedding │ ││ │Evolution │ ││ │Insights│ │
│ │  States  │ ││ │ Manager  │ ││ │ Creator  │ ││ │ Tracker  │ ││ │        │ │
│ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └──────────┘ ││ └────────┘ │
└──────┬───────┘└──────┬───────┘└──────┬───────┘└──────┬───────┘└──────┬─────┘
       │               │               │               │               │
       ▼               ▼               ▼               ▼               ▼
┌──────────────┐┌──────────────┐┌──────────────┐┌──────────────┐┌────────────┐
│ telegram_    ││ onboarding_  ││ analysis_    ││ profiles_    ││ coach_     │
│ system DB    ││ system DB    ││ system DB    ││ store DB     ││ system DB  │
│              ││              ││              ││              ││            │
│ - users      ││ - sessions   ││ - queue      ││ - profiles   ││ - sessions │
│ - fsm_states ││ - answers    ││ - results    ││ - history    ││ - messages │
│              ││ - questions  ││ - traits     ││ - milestones ││ - insights │
└──────────────┘└──────────────┘└──────────────┘└──────────────┘└────────────┘

ПРЕИМУЩЕСТВА:
✅ Loose Coupling - системы независимы
✅ Fault Isolation - падение одной системы не ломает другие
✅ Database per Service - каждая система владеет своими данными
✅ Независимое тестирование - можно тестировать изолированно
✅ Горизонтальное масштабирование - каждую систему отдельно
```

---

## 3. ПОТОК СОБЫТИЙ: ОНБОРДИНГ СЕССИЯ

```
┌─────────┐      ┌──────────┐      ┌────────────┐      ┌─────────┐      ┌──────┐
│  USER   │      │ TELEGRAM │      │ ONBOARDING │      │ANALYSIS │      │PROFILE│
└────┬────┘      └────┬─────┘      └─────┬──────┘      └────┬────┘      └───┬──┘
     │                │                   │                  │               │
     │  /start        │                   │                  │               │
     ├───────────────►│                   │                  │               │
     │                │                   │                  │               │
     │                │ UserStartedEvent  │                  │               │
     │                ├──────────────────►│                  │               │
     │                │                   │                  │               │
     │                │                   │ OnboardingStarted│               │
     │                │                   │      Event       │               │
     │                │                   ├─────────────────►│               │
     │                │                   │                  │               │
     │                │ ShowQuestionEvent │                  │               │
     │                │◄──────────────────┤                  │               │
     │                │                   │                  │               │
     │ ❓ Question    │                   │                  │               │
     │◄───────────────┤                   │                  │               │
     │                │                   │                  │               │
     │ Answer text    │                   │                  │               │
     ├───────────────►│                   │                  │               │
     │                │                   │                  │               │
     │                │QuestionAnswered   │                  │               │
     │                │     Event         │                  │               │
     │                ├──────────────────►│                  │               │
     │                │                   │                  │               │
     │                │                   │ AnalysisRequested│               │
     │                │                   │      Event       │               │
     │                │                   ├─────────────────►│               │
     │                │                   │                  │               │
     │ ⚡ Quick       │                   │                  │  (background) │
     │  feedback      │                   │                  │  AI analysis  │
     │◄───────────────┤                   │                  │  2-10 sec     │
     │                │                   │                  │               │
     │                │                   │                  │               │
     │                │                   │ AnalysisCompleted│               │
     │                │                   │◄─────────────────┤               │
     │                │                   │                  │               │
     │                │                   │                  │TraitsExtracted│
     │                │                   │                  │     Event     │
     │                │                   │                  ├──────────────►│
     │                │                   │                  │               │
     │                │                   │                  │               │
     │                │ ShowNextQuestion  │                  │               │
     │                │◄──────────────────┤                  │               │
     │                │                   │                  │               │
     │ ❓ Next        │                   │                  │               │
     │  Question      │                   │                  │               │
     │◄───────────────┤                   │                  │               │
     │                │                   │                  │               │

КЛЮЧЕВЫЕ МОМЕНТЫ:
1. Мгновенный фидбек (<500ms) - пользователь не ждет
2. Глубокий анализ в фоне - не блокирует UX
3. Системы общаются через события - нет прямых вызовов
4. Каждая система может работать независимо
```

---

## 4. BOUNDED CONTEXTS (DDD)

```
┌────────────────────────────────────────────────────────────────────────┐
│                         SELFOLOGY DOMAIN                               │
└────────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐         ┌───────────────┐
│  INTERACTION  │          │  ASSESSMENT   │         │  PSYCHOLOGY   │
│   CONTEXT     │          │   CONTEXT     │         │   CONTEXT     │
│               │          │               │         │               │
│ - Telegram    │          │ - Onboarding  │         │ - Profile     │
│   System      │          │   System      │         │   System      │
│               │          │ - Analysis    │         │ - Coach       │
│ Entities:     │          │   System      │         │   System      │
│ - TelegramUser│          │               │         │               │
│ - FSMState    │          │ Entities:     │         │ Entities:     │
│ - Message     │          │ - Session     │         │ - Profile     │
│               │          │ - Question    │         │ - Trait       │
│ Aggregates:   │          │ - Answer      │         │ - Evolution   │
│ - UserSession │          │               │         │ - Insight     │
│               │          │ Aggregates:   │         │               │
│               │          │ - Onboarding  │         │ Aggregates:   │
│               │          │   Session     │         │ - Personality │
│               │          │               │         │   Profile     │
└───────────────┘          └───────────────┘         └───────────────┘

Каждый Bounded Context:
- Имеет собственную Ubiquitous Language (единый язык)
- Владеет своими данными
- Имеет четкие границы (API/Events)
- Может эволюционировать независимо
```

---

## 5. DATABASE SCHEMA РАЗДЕЛЕНИЕ

```
┌────────────────────────────────────────────────────────────────────────┐
│                      PostgreSQL Database: n8n                          │
└────────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐         ┌───────────────┐
│  telegram_    │          │ onboarding_   │         │ analysis_     │
│   system      │          │   system      │         │  system       │
│               │          │               │         │               │
│ ┌───────────┐ │          │ ┌───────────┐ │         │ ┌───────────┐ │
│ │ users     │ │          │ │ sessions  │ │         │ │ queue     │ │
│ ├───────────┤ │          │ ├───────────┤ │         │ ├───────────┤ │
│ │telegram_id│ │          │ │session_id │ │         │ │answer_id  │ │
│ │username   │ │          │ │user_id    │ │         │ │priority   │ │
│ │first_name │ │          │ │status     │ │         │ │status     │ │
│ └───────────┘ │          │ └───────────┘ │         │ └───────────┘ │
│               │          │               │         │               │
│ ┌───────────┐ │          │ ┌───────────┐ │         │ ┌───────────┐ │
│ │fsm_states │ │          │ │ answers   │ │         │ │ results   │ │
│ ├───────────┤ │          │ ├───────────┤ │         │ ├───────────┤ │
│ │telegram_id│ │          │ │session_id │ │         │ │answer_id  │ │
│ │state      │ │          │ │question_id│ │         │ │insights   │ │
│ │state_data │ │          │ │answer_text│ │         │ │model_used │ │
│ └───────────┘ │          │ └───────────┘ │         │ └───────────┘ │
│               │          │               │         │               │
│               │          │ ┌───────────┐ │         │ ┌───────────┐ │
│               │          │ │ questions │ │         │ │  traits   │ │
│               │          │ │  metadata │ │         │ ├───────────┤ │
│               │          │ ├───────────┤ │         │ │analysis_id│ │
│               │          │ │question_id│ │         │ │openness   │ │
│               │          │ │domain     │ │         │ │...        │ │
│               │          │ │is_flagged │ │         │ └───────────┘ │
│               │          │ └───────────┘ │         │               │
└───────────────┘          └───────────────┘         └───────────────┘

        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐         ┌───────────────┐
│ profiles_     │          │  coach_       │         │  shared       │
│  store        │          │   system      │         │  (read-only)  │
│               │          │               │         │               │
│ ┌───────────┐ │          │ ┌───────────┐ │         │ ┌───────────┐ │
│ │ profiles  │ │          │ │ sessions  │ │         │ │users_basic│ │
│ ├───────────┤ │          │ ├───────────┤ │         │ │   VIEW    │ │
│ │profile_id │ │          │ │session_id │ │         │ │           │ │
│ │user_id    │ │          │ │user_id    │ │         │ │telegram_id│ │
│ │profile_   │ │          │ │started_at │ │         │ │username   │ │
│ │  data     │ │          │ └───────────┘ │         │ └───────────┘ │
│ └───────────┘ │          │               │         │               │
│               │          │ ┌───────────┐ │         │ (Объединяет   │
│ ┌───────────┐ │          │ │ messages  │ │         │  данные из    │
│ │  history  │ │          │ ├───────────┤ │         │  разных       │
│ ├───────────┤ │          │ │session_id │ │         │  схем для     │
│ │profile_id │ │          │ │role       │ │         │  общего       │
│ │trait_name │ │          │ │content    │ │         │  доступа)     │
│ │old_value  │ │          │ └───────────┘ │         │               │
│ │new_value  │ │          │               │         └───────────────┘
│ └───────────┘ │          │ ┌───────────┐ │
│               │          │ │ insights  │ │
│               │          │ ├───────────┤ │
│               │          │ │user_id    │ │
│               │          │ │content    │ │
│               │          │ └───────────┘ │
└───────────────┘          └───────────────┘

ПРАВИЛА:
✅ Каждая система владеет своей схемой
✅ Нет FOREIGN KEY между схемами
✅ Связь через user_id (внешний идентификатор)
✅ Shared schema только для READ-ONLY views
✅ Изменения через Events, не через прямые UPDATE
```

---

## 6. МАСШТАБИРОВАНИЕ АРХИТЕКТУРЫ

```
┌────────────────────────────────────────────────────────────────────────┐
│                         LOAD BALANCER                                  │
│                    (NGINX / Traefik)                                   │
└────────────────────────────────────────────────────────────────────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐         ┌───────────────┐
│  Telegram     │          │ Onboarding    │         │  Analysis     │
│  System       │          │   System      │         │   System      │
│               │          │               │         │               │
│ ┌─────────┐   │          │ ┌─────────┐   │         │ ┌─────────┐   │
│ │Instance1│   │          │ │Instance1│   │         │ │Instance1│   │
│ └─────────┘   │          │ └─────────┘   │         │ └─────────┘   │
│               │          │               │         │               │
│ ┌─────────┐   │          │ ┌─────────┐   │         │ ┌─────────┐   │
│ │Instance2│   │          │ │Instance2│   │         │ │Instance2│   │
│ └─────────┘   │          │ └─────────┘   │         │ └─────────┘   │
│               │          │               │         │               │
│               │          │ ┌─────────┐   │         │ ┌─────────┐   │
│               │          │ │Instance3│   │         │ │Instance3│   │
│               │          │ └─────────┘   │         │ └─────────┘   │
│               │          │               │         │               │
│               │          │               │         │ ┌─────────┐   │
│               │          │               │         │ │Instance4│   │
│               │          │               │         │ └─────────┘   │
│               │          │               │         │               │
│               │          │               │         │ ┌─────────┐   │
│               │          │               │         │ │Instance5│   │
│               │          │               │         │ └─────────┘   │
└───────────────┘          └───────────────┘         └───────────────┘
     (2 pods)                  (3 pods)                  (5 pods)
     Light load              Medium load               Heavy load

┌────────────────────────────────────────────────────────────────────────┐
│                         MESSAGE QUEUE                                  │
│                      (RabbitMQ / Redis)                                │
│                                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │
│  │ Analysis     │  │ Profile      │  │ Notification │                │
│  │ Queue        │  │ Update Queue │  │ Queue        │                │
│  └──────────────┘  └──────────────┘  └──────────────┘                │
└────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────┐
│                       DATABASE CLUSTER                                 │
│                                                                        │
│  ┌──────────────┐           ┌──────────────┐                          │
│  │  Primary     │  ──────►  │  Replica 1   │                          │
│  │  (Write)     │           │  (Read)      │                          │
│  └──────────────┘           └──────────────┘                          │
│         │                           │                                  │
│         │                   ┌──────────────┐                          │
│         └──────────────────►│  Replica 2   │                          │
│                             │  (Read)      │                          │
│                             └──────────────┘                          │
└────────────────────────────────────────────────────────────────────────┘

СТРАТЕГИЯ:
- Telegram System: 2 инстанса (легкая нагрузка)
- Onboarding System: 3 инстанса (средняя нагрузка)
- Analysis System: 5 инстансов (тяжелая нагрузка, AI обработка)
- Profile System: 2 инстанса (средняя нагрузка)
- Coach System: 3 инстанса (AI генерация)
```

---

## 7. FAULT TOLERANCE (ИЗОЛЯЦИЯ ОТКАЗОВ)

```
СЦЕНАРИЙ: Analysis System упал

┌─────────┐      ┌──────────┐      ┌────────────┐      ┌─────────┐
│  USER   │      │ TELEGRAM │      │ ONBOARDING │      │ANALYSIS │
└────┬────┘      └────┬─────┘      └─────┬──────┘      └────┬────┘
     │                │                   │                  │
     │  Answer        │                   │                  │
     ├───────────────►│                   │                  │
     │                │                   │                  │
     │                │ QuestionAnswered  │                  │
     │                │     Event         │                  │
     │                ├──────────────────►│                  │
     │                │                   │                  │
     │                │                   │ AnalysisRequested│
     │                │                   │      Event       │
     │                │                   ├─────────────────►│
     │                │                   │                  X CRASHED
     │ ⚡ Quick       │                   │
     │  feedback      │                   │
     │◄───────────────┤                   │
     │                │                   │
     │ "Ответ        │                   │  ✅ Сохранен в БД
     │  получен!"     │                   │  ✅ Добавлен в очередь
     │                │                   │  ✅ Будет обработан позже
     │                │                   │
     │                │ ShowNextQuestion  │
     │                │◄──────────────────┤
     │                │                   │
     │ ❓ Next        │                   │
     │  Question      │                   │
     │◄───────────────┤                   │
     │                │                   │
     │                │                   │  Analysis System
     │                │                   │  восстановлен
     │                │                   │                  │
     │                │                   │                  ▼
     │                │                   │  ┌──────────────────────┐
     │                │                   │  │ Обработка очереди:   │
     │                │                   │  │ - Answer #1 (OK)     │
     │                │                   │  │ - Answer #2 (OK)     │
     │                │                   │  │ - Answer #3 (OK)     │
     │                │                   │  └──────────────────────┘
     │                │                   │                  │
     │                │                   │ AnalysisCompleted│
     │                │                   │◄─────────────────┤
     │                │                   │                  │

РЕЗУЛЬТАТ:
✅ Пользователь продолжил онбординг без прерывания
✅ Ответы сохранены и не потеряны
✅ Анализ выполнен автоматически после восстановления
✅ Никакого manual intervention не требуется
```

---

## 8. DEPLOYMENT STRATEGY (БЕЗ DOWNTIME)

```
BLUE-GREEN DEPLOYMENT для Analysis System:

BEFORE UPDATE:
┌────────────────────────────────────────────────────────────────┐
│                      LOAD BALANCER                             │
└────────────────────────────────────────────────────────────────┘
                              │
                              ▼ (100% traffic)
                    ┌───────────────────┐
                    │  BLUE (v1.0)      │
                    │  Analysis System  │
                    │  ┌─────────────┐  │
                    │  │ Instance 1  │  │
                    │  │ Instance 2  │  │
                    │  │ Instance 3  │  │
                    │  └─────────────┘  │
                    └───────────────────┘

STEP 1: Deploy GREEN (v2.0)
┌────────────────────────────────────────────────────────────────┐
│                      LOAD BALANCER                             │
└────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼ (100%)                    ▼ (0%)
      ┌───────────────────┐       ┌───────────────────┐
      │  BLUE (v1.0)      │       │  GREEN (v2.0)     │
      │  Analysis System  │       │  Analysis System  │
      │  ┌─────────────┐  │       │  ┌─────────────┐  │
      │  │ Instance 1  │  │       │  │ Instance 1  │  │
      │  │ Instance 2  │  │       │  │ Instance 2  │  │
      │  │ Instance 3  │  │       │  │ Instance 3  │  │
      │  └─────────────┘  │       │  └─────────────┘  │
      └───────────────────┘       └───────────────────┘

STEP 2: Gradually shift traffic (10% → 50% → 100%)
┌────────────────────────────────────────────────────────────────┐
│                      LOAD BALANCER                             │
└────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼ (10%)                     ▼ (90%)
      ┌───────────────────┐       ┌───────────────────┐
      │  BLUE (v1.0)      │       │  GREEN (v2.0)     │
      │  Finishing queue  │       │  Processing new   │
      └───────────────────┘       └───────────────────┘

STEP 3: Monitor metrics
      ┌───────────────────────────────────────┐
      │  GREEN (v2.0) Metrics:                │
      │  - Throughput: ✅ Same as v1.0        │
      │  - Error rate: ✅ 0.1% (normal)       │
      │  - Latency: ✅ -15% (improved!)       │
      └───────────────────────────────────────┘

STEP 4: Rollback if needed (instant!)
      If GREEN fails → switch back to BLUE
      ┌────────────────────────────────────────┐
      │  Emergency Rollback:                   │
      │  LoadBalancer.route(BLUE, weight=100%) │
      │  Time: <1 second                       │
      └────────────────────────────────────────┘

STEP 5: Decommission BLUE
      ┌────────────────────────────────────────┐
      │  GREEN (v2.0) stable for 24h          │
      │  → Shut down BLUE                      │
      │  → Release resources                   │
      └────────────────────────────────────────┘

ПРЕИМУЩЕСТВА:
✅ Zero downtime
✅ Instant rollback capability
✅ Gradual traffic shift (canary)
✅ Independent deployment of systems
```

---

## 9. TESTING STRATEGY

```
UNIT TESTS (каждая система изолированно):

┌─────────────────────────────────────────────────────────────────┐
│                    Onboarding System Tests                      │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ test_question_selection()                                │  │
│  │   - Mock: Event Bus                                      │  │
│  │   - Mock: Database                                       │  │
│  │   - Real: QuestionRouter logic                           │  │
│  │   - Assert: Correct question selected                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ test_fatigue_detection()                                 │  │
│  │   - Mock: Database                                       │  │
│  │   - Real: FatigueDetector logic                          │  │
│  │   - Assert: Fatigue level calculated correctly           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

INTEGRATION TESTS (межсистемное взаимодействие):

┌─────────────────────────────────────────────────────────────────┐
│               End-to-End Onboarding Flow                        │
│                                                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │ Telegram │─►│Onboarding│─►│ Analysis │─►│ Profile  │       │
│  │  System  │  │  System  │  │  System  │  │  System  │       │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘       │
│                                                                 │
│  Real Event Bus, Real Databases                                │
│  Mock: External AI APIs (Claude/GPT)                           │
│                                                                 │
│  Assertions:                                                   │
│  ✅ Question shown to user                                     │
│  ✅ Answer saved to database                                   │
│  ✅ Analysis queued                                            │
│  ✅ Traits extracted                                           │
│  ✅ Profile updated                                            │
└─────────────────────────────────────────────────────────────────┘

CHAOS ENGINEERING (изоляция отказов):

┌─────────────────────────────────────────────────────────────────┐
│            Chaos Test: Kill Analysis System                     │
│                                                                 │
│  1. Start all systems                                          │
│  2. User sends 10 answers                                      │
│  3. KILL Analysis System (mid-processing)                      │
│  4. User continues sending answers                             │
│  5. Restart Analysis System                                    │
│                                                                 │
│  Expected Results:                                             │
│  ✅ User never experiences error                               │
│  ✅ All 10 answers saved                                       │
│  ✅ All 10 answers analyzed after restart                      │
│  ✅ No data loss                                               │
└─────────────────────────────────────────────────────────────────┘

LOAD TESTS (масштабируемость):

┌─────────────────────────────────────────────────────────────────┐
│              Load Test: 1000 concurrent users                   │
│                                                                 │
│  Scenario:                                                     │
│  - 1000 users start onboarding simultaneously                 │
│  - Each user answers 10 questions                             │
│  - Measure: throughput, latency, error rate                   │
│                                                                 │
│  With Scaling:                                                 │
│  - Onboarding System: 3 → 10 instances                        │
│  - Analysis System: 5 → 20 instances                          │
│                                                                 │
│  Results:                                                      │
│  ✅ Average latency: <500ms (p95)                             │
│  ✅ Error rate: <0.1%                                         │
│  ✅ All 10,000 answers processed                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## ЗАКЛЮЧЕНИЕ

Эта архитектура обеспечивает:

1. **Модульность** - четкие границы между системами
2. **Изоляция** - падение одной системы не ломает другие
3. **Масштабируемость** - каждую систему можно масштабировать отдельно
4. **Тестируемость** - системы тестируются изолированно
5. **Гибкость** - легко добавлять новые системы
6. **Maintainability** - изменения в одной системе не затрагивают другие

**Следующий шаг:** Начать с Фазы 0 - Event Bus и Domain Events
