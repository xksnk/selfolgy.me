# Onboarding Pipeline Monitoring System

Comprehensive monitoring system –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ–≥–æ –ø—É—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç Telegram –æ—Ç–≤–µ—Ç–∞ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Digital Personality.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è](#—á—Ç–æ-–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- [–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ](#–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ)
- [–ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è](#–∞–ª–µ—Ä—Ç—ã-–∏-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
- [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Ç—Ä–∞–∏](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ-—Ä–µ—Ç—Ä–∞–∏)
- [API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏](#api-–∏-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               OnboardingMonitoringSystem                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ Pipeline Monitor ‚îÇ  ‚îÇ Telegram Alerter ‚îÇ  ‚îÇ Auto-Retry ‚îÇ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Real-time      ‚îÇ  ‚îÇ ‚Ä¢ Smart grouping ‚îÇ  ‚îÇ ‚Ä¢ Exp back ‚îÇ‚îÇ
‚îÇ  ‚îÇ   tracking       ‚îÇ  ‚îÇ ‚Ä¢ Rate limiting  ‚îÇ  ‚îÇ ‚Ä¢ Recover  ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Metrics        ‚îÇ  ‚îÇ ‚Ä¢ Severity       ‚îÇ  ‚îÇ   errors   ‚îÇ‚îÇ
‚îÇ  ‚îÇ ‚Ä¢ Health checks  ‚îÇ  ‚îÇ   levels         ‚îÇ  ‚îÇ ‚Ä¢ Stats    ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Pipeline Monitor

–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞:

1. **Telegram ‚Üí SQL**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –≤ –ë–î
2. **SQL ‚Üí AI Analysis**: –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ AI
3. **AI ‚Üí Vectorization**: –°–æ–∑–¥–∞–Ω–∏–µ embeddings –≤ Qdrant
4. **Vectorization ‚Üí DP Update**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Digital Personality

### Telegram Alerter

–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –≤ Telegram:

- **Rate Limiting**: –ù–µ —Å–ø–∞–º–∏—Ç, –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∞–ª–µ—Ä—Ç—ã
- **Severity Levels**: warning, error, critical
- **Smart Grouping**: –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∞–ª–µ—Ä—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥
- **Formatted Messages**: –ö—Ä–∞—Å–∏–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç–º–æ–¥–∑–∏

### Auto-Retry Manager

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç failed –æ–ø–µ—Ä–∞—Ü–∏–∏:

- **Exponential Backoff**: 1min ‚Üí 5min ‚Üí 15min ‚Üí 30min
- **Smart Recovery**: –¢–æ–ª—å–∫–æ –¥–ª—è –∏—Å–ø—Ä–∞–≤–∏–º—ã—Ö –æ—à–∏–±–æ–∫
- **Max Retries**: Configurable limit (default: 3)
- **Success Tracking**: –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Ä–µ—Ç—Ä–∞–µ–≤

## –ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
{
    'timing': {
        'sql_save_ms': 50,           # –í—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
        'ai_analysis_ms': 3500,      # –í—Ä–µ–º—è AI –∞–Ω–∞–ª–∏–∑–∞
        'vectorization_ms': 1200,    # –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤
        'dp_update_ms': 800,         # –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DP
        'total_pipeline_ms': 5550    # –ü–æ–ª–Ω–æ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    },
    'success_rates': {
        'ai_analysis': '100.0%',
        'vectorization': '98.5%',
        'dp_update': '99.2%'
    },
    'queue_depth': {
        'pending_analyses': 2,
        'pending_vectorizations': 1,
        'pending_dp_updates': 0
    },
    'errors': {
        'ai_errors': 0,
        'vectorization_errors': 3,
        'dp_update_errors': 1
    }
}
```

### –¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤

1. **error** - –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
2. **slow_processing** - –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (>15 —Å–µ–∫)
3. **stuck_task** - –ó–∞–≤–∏—Å—à–∏–π background task (>5 –º–∏–Ω)
4. **high_failure_rate** - –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ (>20%)
5. **service_unhealthy** - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ (Qdrant, PostgreSQL, OpenAI)
6. **stuck_processing** - Pending —Å—Ç–∞—Ç—É—Å –¥–æ–ª–≥–æ –≤–∏—Å–∏—Ç (>5 –º–∏–Ω)

### Health Checks

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

- **PostgreSQL**: Connection, response time, active connections
- **Qdrant**: API availability, collections status
- **OpenAI API**: API availability, rate limits
- **Redis**: Connection (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ .env

```bash
# Telegram Alerts
TELEGRAM_ALERTS_ENABLED=true
TELEGRAM_ALERTS_MIN_SEVERITY=warning  # warning, error, critical
MONITORING_ADMIN_IDS=98005572         # Comma-separated

# Alert Rate Limiting
ALERT_MAX_PER_TYPE=5           # Max alerts of same type per window
ALERT_WINDOW_MINUTES=60        # Time window for rate limiting
ALERT_GROUP_WINDOW=60          # Seconds to group similar alerts

# Performance Thresholds
ONBOARDING_SLOW_THRESHOLD_MS=15000    # 15 seconds
ONBOARDING_STUCK_THRESHOLD_SEC=300    # 5 minutes
ONBOARDING_FAILURE_THRESHOLD=0.2      # 20%

# Auto-Retry Configuration
AUTO_RETRY_ENABLED=true
AUTO_RETRY_MAX_ATTEMPTS=3
```

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥

#### –í selfology_controller.py –∏–ª–∏ main.py:

```python
from selfology_bot.monitoring import initialize_onboarding_monitoring
import os

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
async def startup():
    # ... existing startup code ...

    # Initialize monitoring
    db_config = {
        "host": os.getenv("DB_HOST"),
        "port": int(os.getenv("DB_PORT", 5432)),
        "user": os.getenv("DB_USER"),
        "password": os.getenv("DB_PASSWORD"),
        "database": os.getenv("DB_NAME")
    }

    monitoring = await initialize_onboarding_monitoring(
        db_config=db_config,
        bot_token=os.getenv("BOT_TOKEN"),
        admin_chat_ids=[int(id) for id in os.getenv("MONITORING_ADMIN_IDS").split(",")],
        enable_alerting=os.getenv("TELEGRAM_ALERTS_ENABLED", "true").lower() == "true",
        enable_auto_retry=os.getenv("AUTO_RETRY_ENABLED", "true").lower() == "true"
    )

    # Start monitoring in background
    asyncio.create_task(monitoring.start())

    logger.info("Onboarding monitoring started")

# Shutdown
async def shutdown():
    from selfology_bot.monitoring import get_monitoring_system

    monitoring = get_monitoring_system()
    if monitoring:
        await monitoring.stop()
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### CLI –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç

```bash
# –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å pipeline
python scripts/onboarding_monitoring_cli.py status

# –¢–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
python scripts/onboarding_monitoring_cli.py metrics

# –û—à–∏–±–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 —á–∞—Å–æ–≤
python scripts/onboarding_monitoring_cli.py errors --hours 6

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤
python scripts/onboarding_monitoring_cli.py health

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ç—Ä–∞–µ–≤
python scripts/onboarding_monitoring_cli.py retry-stats

# –°–≤–æ–¥–∫–∞ –∑–∞ 24 —á–∞—Å–∞
python scripts/onboarding_monitoring_cli.py summary --hours 24

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (standalone)
python scripts/onboarding_monitoring_cli.py start

# JSON –≤—ã–≤–æ–¥ (–¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π)
python scripts/onboarding_monitoring_cli.py json
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –¥–æ—Å—Ç—É–ø

```python
from selfology_bot.monitoring import get_monitoring_system

# –ü–æ–ª—É—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
monitoring = get_monitoring_system()

# –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
metrics = await monitoring.get_current_metrics()

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å pipeline –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
status = await monitoring.get_pipeline_status(user_id=98005572)

# –ü–æ–ª—É—á–∏—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–µ –æ—à–∏–±–∫–∏
errors = await monitoring.get_recent_errors(hours=6)

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
health = await monitoring.check_services_health()

# –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –º–µ—Ç—Ä–∏–∫
summary = await monitoring.get_metrics_summary(hours=24)

# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–µ—Ç—Ä–∞–µ–≤
retry_stats = await monitoring.get_retry_stats()
```

## –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä Telegram –∞–ª–µ—Ä—Ç–∞

```
üö® Selfology Alert üêå

Type: Slow Processing
Severity: WARNING

Message:
Slow background processing: 18500ms

Details:
‚Ä¢ analysis_id: 123
‚Ä¢ answer_id: 456
‚Ä¢ user_id: 98005572
‚Ä¢ ai_time_ms: 3200
‚Ä¢ background_time_ms: 18500

Time: 2025-10-03 15:30:42 UTC
```

### –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–ª–µ—Ä—Ç

```
üö® Selfology Alerts (5) ‚ùå

Type: Vectorization Error
Max Severity: ERROR

Recent occurrences:

1. Vectorization failed: Connection timeout
   user_id=98005572, answer_id=123

2. Vectorization failed: Connection timeout
   user_id=98005573, answer_id=124

3. Vectorization failed: Connection timeout
   user_id=98005574, answer_id=125

... and 2 more similar alerts

Time: 2025-10-03 15:30:42 UTC
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ severity

–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã:

```bash
TELEGRAM_ALERTS_MIN_SEVERITY=critical
```

–£—Ä–æ–≤–Ω–∏ severity:
- **warning**: –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, degraded —Å–µ—Ä–≤–∏—Å—ã
- **error**: –û—à–∏–±–∫–∏ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, DP updates
- **critical**: –ü–æ–ª–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤, –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–¥–∞—á–∏

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Ç—Ä–∞–∏

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ failed –æ–ø–µ—Ä–∞—Ü–∏–π** –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
2. **Exponential backoff**: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è
   - 1 –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
   - 2 –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
   - 3 –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç
   - 4 –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç

3. **Smart recovery**: –ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–∫–∏
   - **Recoverable**: Network timeouts, service unavailable, rate limits
   - **Non-recoverable**: Invalid data, authorization errors

4. **Max retries**: –ü–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ - –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º —Ä–µ—Ç—Ä–∞–∏—Ç—å

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Ç—Ä–∞–µ–≤

```python
# –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
retry_stats = await monitoring.get_retry_stats()

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
    'total_retries': 47,
    'successful_retries': 42,
    'failed_retries': 5,
    'success_rate': 89.4
}
```

### –†—É—á–Ω–æ–π —Ä–µ—Ç—Ä–∞–π

–î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ä–µ—Ç—Ä–∞—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∫—Ä–∏–ø—Ç—ã:

```bash
# Reprocess single answer
python scripts/reprocess_single_answer.py 123

# Reprocess missing vectors
python reprocess_missing_vectors.py
```

## API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤:

```python
from selfology_bot.monitoring import get_onboarding_monitor

monitor = get_onboarding_monitor()

async def webhook_callback(alert):
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≤–∞—à webhook
    async with httpx.AsyncClient() as client:
        await client.post(
            "https://your-webhook.com/alerts",
            json=alert.to_dict()
        )

monitor.register_alert_callback(webhook_callback)
```

### Prometheus –º–µ—Ç—Ä–∏–∫–∏

–ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –≤ Prometheus format:

```python
from selfology_bot.monitoring import get_monitoring_system

monitoring = get_monitoring_system()
metrics = await monitoring.get_current_metrics()

# Convert to Prometheus format
prometheus_metrics = f"""
# HELP onboarding_ai_analysis_ms Average AI analysis time
# TYPE onboarding_ai_analysis_ms gauge
onboarding_ai_analysis_ms {metrics['timing']['ai_analysis_ms']}

# HELP onboarding_vectorization_success_rate Vectorization success rate
# TYPE onboarding_vectorization_success_rate gauge
onboarding_vectorization_success_rate {float(metrics['success_rates']['vectorization'].rstrip('%'))/100}
"""
```

### Grafana Dashboard

–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Grafana dashboard –∏—Å–ø–æ–ª—å–∑—É—è PostgreSQL datasource:

```sql
-- –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
SELECT
    DATE_TRUNC('minute', aa.processed_at) as time,
    AVG(aa.processing_time_ms) as ai_time,
    AVG(aa.background_task_duration_ms) as total_time,
    COUNT(*) FILTER (WHERE aa.vectorization_status = 'success') as vec_success,
    COUNT(*) FILTER (WHERE aa.vectorization_status = 'failed') as vec_failed
FROM selfology.answer_analysis aa
WHERE aa.processed_at > NOW() - INTERVAL '1 hour'
GROUP BY DATE_TRUNC('minute', aa.processed_at)
ORDER BY time
```

## Troubleshooting

### –ê–ª–µ—Ä—Ç—ã –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:
```bash
echo $TELEGRAM_ALERTS_ENABLED
echo $MONITORING_ADMIN_IDS
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–æ—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω—É:
```python
from aiogram import Bot

bot = Bot(token=os.getenv("BOT_TOKEN"))
await bot.send_message(98005572, "Test alert")
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ severity level:
```bash
# –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω critical - warning –∏ error –∞–ª–µ—Ä—Ç—ã –Ω–µ –ø—Ä–∏–¥—É—Ç
TELEGRAM_ALERTS_MIN_SEVERITY=warning
```

### –†–µ—Ç—Ä–∞–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ AUTO_RETRY_ENABLED=true
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω MAX_RETRIES:
```sql
SELECT * FROM selfology.answer_analysis
WHERE retry_count >= 3 AND vectorization_status = 'failed';
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫:
```bash
grep "AutoRetryManager" logs/selfology.log
```

### –ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –∞–ª–µ—Ä—Ç—ã –æ –º–µ–¥–ª–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É AI API:
```bash
python scripts/onboarding_monitoring_cli.py health
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—á–µ—Ä–µ–¥–∏:
```bash
python scripts/onboarding_monitoring_cli.py metrics
```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:
```bash
htop  # CPU –∏ –ø–∞–º—è—Ç—å
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- **Existing monitoring**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –≤ `core/monitoring_orchestrator.py`
- **Logging**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è `selfology_bot/core/logging.py`
- **Database schema**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–ª—è–º–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead**: –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫

## Best Practices

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ production**: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–π—Ç–µ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
2. **Severity levels**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `warning` –¥–ª—è development, `error` –¥–ª—è production
3. **Daily summaries**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π —Å–≤–æ–¥–∫–∏:
```python
# –í cron –∏–ª–∏ scheduler
monitoring = get_monitoring_system()
await monitoring.send_daily_summary()
```

4. **Regular checks**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ cron
*/5 * * * * python scripts/onboarding_monitoring_cli.py health
```

5. **Alert fatigue**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ rate limiting —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –∞–¥–º–∏–Ω–∞ –∞–ª–µ—Ä—Ç–∞–º–∏

## Support

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:
- GitHub Issues: [selfology/issues](https://github.com/...)
- Telegram: @admin
