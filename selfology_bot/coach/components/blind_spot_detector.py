"""
Blind Spot Detector - –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–µ–ø—ã—Ö –∑–æ–Ω —Å–∞–º–æ–≤–æ—Å–ø—Ä–∏—è—Ç–∏—è

üéØ –¶–ï–õ–¨: –í—ã—è–≤–∏—Ç—å –æ–±–ª–∞—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –∏–ª–∏ –∏–∑–±–µ–≥–∞–µ—Ç
üìö –û–°–ù–û–í–ê: Patterns of avoidance, contradictions, rationalizations
‚ö†Ô∏è –î–ï–õ–ò–ö–ê–¢–ù–û–°–¢–¨: –°–ª–µ–ø—ã–µ –∑–æ–Ω—ã –≤—Å–∫—Ä—ã–≤–∞—Ç—å –û–ß–ï–ù–¨ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ (alliance > 0.7)
"""

import re
import logging
from typing import List, Dict, Any, Optional
from dataclasses import dataclass

logger = logging.getLogger(__name__)


@dataclass
class DetectedBlindSpot:
    """–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è —Å–ª–µ–ø–∞—è –∑–æ–Ω–∞"""
    spot_type: str  # avoidance, contradiction, rationalization, deflection
    category: str  # emotions, relationships, self, responsibility, vulnerability
    confidence: float  # 0.0 - 1.0
    evidence: str  # –§—Ä–∞–∑–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
    pattern_description: str  # –û–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    gentle_question: str  # –ú—è–≥–∫–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è


class BlindSpotDetector:
    """
    –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–ª–µ–ø—ã—Ö –∑–æ–Ω –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑–±–µ–≥–∞–Ω–∏—è

    –¢–∏–ø—ã —Å–ª–µ–ø—ã—Ö –∑–æ–Ω:
    1. Avoidance - –∏–∑–±–µ–≥–∞–Ω–∏–µ —Ç–µ–º
    2. Contradiction - –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏
    3. Rationalization - —Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—è—Ç–∏—è
    4. Deflection - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å —Å–µ–±—è –Ω–∞ –¥—Ä—É–≥–∏—Ö

    ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—ã–Ω–æ—Å–∏—Ç—å —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–æ–≤–µ—Ä–∏—è
    """

    # –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–ª–µ–ø—ã—Ö –∑–æ–Ω
    BLIND_SPOT_PATTERNS = {
        # === –ò–ó–ë–ï–ì–ê–ù–ò–ï (Avoidance) ===
        "emotion_avoidance": {
            "type": "avoidance",
            "category": "emotions",
            "patterns": [
                r"\b–Ω–µ\s+–∑–Ω–∞—é,?\s+—á—Ç–æ\s+(?:—á—É–≤—Å—Ç–≤—É—é|–æ—â—É—â–∞—é)\b",
                r"\b–Ω–µ\s+(?:–¥—É–º–∞—é|–¥—É–º–∞–ª[–∞–∏]?)\s+–æ–±\s+—ç—Ç–æ–º\b",
                r"\b–Ω–µ\s+—Ö–æ—á—É\s+–≥–æ–≤–æ—Ä–∏—Ç—å\s+(?:–æ–±\s+—ç—Ç–æ–º|–ø—Ä–æ\s+—ç—Ç–æ)\b",
                r"\b—ç—Ç–æ\s+(?:–Ω–µ–≤–∞–∂–Ω–æ|–Ω–µ\s+–≤–∞–∂–Ω–æ)\b",
                r"\b–¥–∞–≤–∞–π—Ç–µ\s+(?:–æ\s+–¥—Ä—É–≥–æ–º|—Å–º–µ–Ω–∏–º\s+—Ç–µ–º—É)\b",
                r"\b–ø—Ä–æ–ø—É—Å—Ç–∏–º\s+—ç—Ç–æ—Ç\s+–≤–æ–ø—Ä–æ—Å\b"
            ],
            "description": "–ò–∑–±–µ–≥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å —ç–º–æ—Ü–∏—è–º–∏",
            "question": "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ–± —ç—Ç–æ–º?"
        },
        "vulnerability_avoidance": {
            "type": "avoidance",
            "category": "vulnerability",
            "patterns": [
                r"\b—è\s+(?:—Å–ø—Ä–∞–≤–ª—è—é—Å—å|—Å–ø—Ä–∞–≤–ª—é—Å—å)\s+—Å–∞–º[–∞–∏]?\b",
                r"\b–º–Ω–µ\s+(?:–Ω–∏–∫—Ç–æ\s+)?–Ω–µ\s+–Ω—É–∂–µ–Ω\b",
                r"\b–ø–æ–º–æ—â—å\s+(?:–Ω–µ\s+–Ω—É–∂–Ω–∞|–Ω–∏\s+–∫\s+—á–µ–º—É)\b",
                r"\b–Ω–µ\s+–ª—é–±–ª—é\s+(?:–ø—Ä–æ—Å–∏—Ç—å|–∂–∞–ª–æ–≤–∞—Ç—å—Å—è)\b",
                r"\b–Ω–æ—Ä–º–∞(?:–ª—å–Ω–æ)?\b.*\b—Å–∞–º[–∞–∏]?\b"
            ],
            "description": "–ò–∑–±–µ–≥–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Å—å–± –æ –ø–æ–º–æ—â–∏",
            "question": "–ö–∞–∫ –±—ã –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Å–∏—Ç—É–∞—Ü–∏—è, –µ—Å–ª–∏ –±—ã –≤—ã –ø–æ–∑–≤–æ–ª–∏–ª–∏ —Å–µ–±–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ?"
        },
        "conflict_avoidance": {
            "type": "avoidance",
            "category": "relationships",
            "patterns": [
                r"\b–Ω–µ\s+—Ö–æ—á—É\s+(?:–∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å|—Å—Å–æ—Ä–∏—Ç—å—Å—è|—Å–ø–æ—Ä–∏—Ç—å)\b",
                r"\b–ª—É—á—à–µ\s+–ø—Ä–æ–º–æ–ª—á—É\b",
                r"\b–Ω–µ\s+–±—É–¥—É\s+(?:–≥–æ–≤–æ—Ä–∏—Ç—å|–ø–æ–¥–Ω–∏–º–∞—Ç—å)\b.*\b–æ–±\s+—ç—Ç–æ–º\b",
                r"\b–Ω–µ\s+—Å—Ç–æ–∏—Ç\s+(?:–æ–±–æ—Å—Ç—Ä—è—Ç—å|—É—Å–ª–æ–∂–Ω—è—Ç—å)\b"
            ],
            "description": "–ò–∑–±–µ–≥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –≤–∞–∂–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤",
            "question": "–ß—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è, –µ—Å–ª–∏ –≤—ã –≤—ã—Å–∫–∞–∂–µ—Ç–µ —Å–≤–æ—é –ø–æ–∑–∏—Ü–∏—é?"
        },

        # === –ü–†–û–¢–ò–í–û–†–ï–ß–ò–Ø (Contradiction) ===
        "say_do_contradiction": {
            "type": "contradiction",
            "category": "self",
            "patterns": [
                r"\b(?:—Ö–æ—á—É|—Ö–æ—Ç–µ–ª[–∞–∏]?)\b.*\b–Ω–æ\s+(?:–Ω–µ\s+)?(?:–¥–µ–ª–∞—é|—Å–¥–µ–ª–∞–ª[–∞–∏]?)\b",
                r"\b–∑–Ω–∞—é,?\s+—á—Ç–æ\s+(?:–Ω—É–∂–Ω–æ|–Ω–∞–¥–æ)\b.*\b–Ω–æ\b",
                r"\b–ø–æ–Ω–∏–º–∞—é\b.*\b–Ω–æ\s+–≤—Å—ë\s+—Ä–∞–≤–Ω–æ\b",
                r"\b–≥–æ–≤–æ—Ä—é\s+—Å–µ–±–µ\b.*\b–Ω–æ\b"
            ],
            "description": "–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –º–µ–∂–¥—É –Ω–∞–º–µ—Ä–µ–Ω–∏—è–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏",
            "question": "–ß—Ç–æ —Å—Ç–æ–∏—Ç –º–µ–∂–¥—É –≤–∞—à–∏–º –∂–µ–ª–∞–Ω–∏–µ–º –∏ –¥–µ–π—Å—Ç–≤–∏–µ–º?"
        },
        "value_behavior_contradiction": {
            "type": "contradiction",
            "category": "values",
            "patterns": [
                r"\b–¥–ª—è\s+–º–µ–Ω—è\s+–≤–∞–∂–Ω–æ\b.*\b–Ω–æ\b.*\b–Ω–µ\b",
                r"\b—Ü–µ–Ω—é\b.*\b–Ω–æ\b.*\b–Ω–µ\b",
                r"\b–≥–ª–∞–≤–Ω–æ–µ\b.*\b–Ω–æ\b"
            ],
            "description": "–ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ –º–µ–∂–¥—É —Ü–µ–Ω–Ω–æ—Å—Ç—è–º–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º",
            "question": "–ö–∞–∫ –≤—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ—Å—å –∫ —ç—Ç–æ–º—É —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—é –º–µ–∂–¥—É —Ç–µ–º, —á—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–æ, –∏ —Ç–µ–º, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ?"
        },

        # === –†–ê–¶–ò–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø (Rationalization) ===
        "excuse_making": {
            "type": "rationalization",
            "category": "responsibility",
            "patterns": [
                r"\b–ø–æ—Ç–æ–º—É\s+—á—Ç–æ\b.*\b–Ω–µ\s+(?:–±—ã–ª–æ|–º–æ–≥[–ª–∞]?)\b",
                r"\b–µ—Å–ª–∏\s+–±—ã\s+–Ω–µ\b.*\b—Ç–æ\s+–±—ã\b",
                r"\b–∏–∑-–∑–∞\s+(?:–Ω–µ–≥–æ|–Ω–µ—ë|–Ω–∏—Ö|—Ä–∞–±–æ—Ç—ã|–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤)\b",
                r"\b(?:—ç—Ç–æ|—Ç–∞–∫)\s+(?:—Å–ª—É—á–∏–ª–æ—Å—å|–ø–æ–ª—É—á–∏–ª–æ—Å—å|–≤—ã—à–ª–æ)\b.*\b—Å–∞–º–æ\b",
                r"\b–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞\s+(?:—Å–ª–æ–∂–∏–ª–∏—Å—å|–≤—ã–Ω—É–¥–∏–ª–∏)\b"
            ],
            "description": "–ü–æ–∏—Å–∫ –≤–Ω–µ—à–Ω–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ –ø—Ä–∏–Ω—è—Ç–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏",
            "question": "–ê –∫–∞–∫—É—é —Ä–æ–ª—å –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Å—ã–≥—Ä–∞–ª–∏ –≤—ã —Å–∞–º–∏?"
        },
        "minimization": {
            "type": "rationalization",
            "category": "emotions",
            "patterns": [
                r"\b—ç—Ç–æ\s+(?:–µ—Ä—É–Ω–¥–∞|–º–µ–ª–æ—á–∏|–ø—É—Å—Ç—è–∫–∏)\b",
                r"\b–Ω–∏—á–µ–≥–æ\s+(?:—Å—Ç—Ä–∞—à–Ω–æ–≥–æ|–æ—Å–æ–±–µ–Ω–Ω–æ–≥–æ)\b",
                r"\b–Ωe\s+—Ç–∞–∫\s+(?:—É–∂|—É–∂\s+–∏)\s+(?:–≤–∞–∂–Ω–æ|—Å—Ç—Ä–∞—à–Ω–æ)\b",
                r"\b–±—ã–≤–∞–µ—Ç\s+(?:–∏\s+)?—Ö—É–∂–µ\b",
                r"\b–ø–æ–¥—É–º–∞–µ—à—å\b"
            ],
            "description": "–ü—Ä–µ—É–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏ —á—É–≤—Å—Ç–≤ –∏–ª–∏ —Å–∏—Ç—É–∞—Ü–∏–∏",
            "question": "–ê –µ—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª–æ –≤–∞–∂–Ω–æ - –∫–∞–∫ –±—ã –≤—ã —Ç–æ–≥–¥–∞ –æ—Ç–Ω–æ—Å–∏–ª–∏—Å—å –∫ —Å–∏—Ç—É–∞—Ü–∏–∏?"
        },

        # === –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï (Deflection) ===
        "other_focus": {
            "type": "deflection",
            "category": "self",
            "patterns": [
                r"\b–∞\s+(?:–≤–æ—Ç\s+)?(?:–æ–Ω|–æ–Ω–∞|–æ–Ω–∏|–¥—Ä—É–≥–∏–µ)\b.*\b(?:–¥–µ–ª–∞—é—Ç|–ø–æ—Å—Ç—É–ø–∞—é—Ç|–≤–µ–¥—É—Ç\s+—Å–µ–±—è)\b",
                r"\b(?:–Ω–æ\s+)?(?:–æ–Ω|–æ–Ω–∞|–æ–Ω–∏)\s+–∂–µ\b",
                r"\b–≤—Å–µ\s+(?:—Ç–∞–∫\s+)?(?:–¥–µ–ª–∞—é—Ç|–∂–∏–≤—É—Ç|–ø–æ—Å—Ç—É–ø–∞—é—Ç)\b",
                r"\b–ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ\s+–Ω–∞\s+(?:–¥—Ä—É–≥–∏—Ö|–Ω–∏—Ö)\b"
            ],
            "description": "–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ —Å —Å–µ–±—è –Ω–∞ –¥—Ä—É–≥–∏—Ö",
            "question": "–ê –∫–∞–∫ —ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –≤–∞—Å?"
        },
        "intellectualization": {
            "type": "deflection",
            "category": "emotions",
            "patterns": [
                r"\b–æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ\s+(?:–≥–æ–≤–æ—Ä—è|–µ—Å–ª–∏)\b",
                r"\b—Å\s+—Ç–æ—á–∫–∏\s+–∑—Ä–µ–Ω–∏—è\b",
                r"\b–ª–æ–≥–∏—á–µ—Å–∫–∏\b.*\b–ø–æ–Ω—è—Ç–Ω–æ\b",
                r"\b—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏\b",
                r"\b–µ—Å–ª–∏\s+—Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è\b"
            ],
            "description": "–£—Ö–æ–¥ –≤ —Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ —á—É–≤—Å—Ç–≤",
            "question": "–û—Ç–ª–æ–∂–∏–≤ –ª–æ–≥–∏–∫—É - —á—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É?"
        },
        "humor_deflection": {
            "type": "deflection",
            "category": "vulnerability",
            "patterns": [
                r"\b(?:—Ö–∞-—Ö–∞|—Ö–∞—Ö–∞—Ö–∞?|–ª–æ–ª|üòÇ|ü§£)\b",
                r"\b—à—É—á—É\b",
                r"\b—ç—Ç–æ\s+—è\s+—Ç–∞–∫\b",
                r"\b–Ω—É\s+–∏\s+–ª–∞–¥–Ω–æ\b.*\b(?:üòÖ|üòÇ)\b"
            ],
            "description": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —é–º–æ—Ä–∞ –¥–ª—è –æ—Ç—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç —á—É–≤—Å—Ç–≤",
            "question": "–ê –µ—Å–ª–∏ —Å–µ—Ä—å—ë–∑–Ω–æ - –∫–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ?"
        }
    }

    def detect(self, text: str) -> List[DetectedBlindSpot]:
        """
        –û–±–Ω–∞—Ä—É–∂–∏—Ç—å —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

        Returns:
            –°–ø–∏—Å–æ–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–ª–µ–ø—ã—Ö –∑–æ–Ω
        """
        if not text or len(text) < 10:
            return []

        text_lower = text.lower()
        detected = []

        for pattern_name, pattern_data in self.BLIND_SPOT_PATTERNS.items():
            for pattern in pattern_data["patterns"]:
                matches = re.findall(pattern, text_lower, re.IGNORECASE)
                if matches:
                    # –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è evidence
                    match = re.search(pattern, text_lower, re.IGNORECASE)
                    if match:
                        # –†–∞—Å—à–∏—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ 50 —Å–∏–º–≤–æ–ª–æ–≤ —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
                        start = max(0, match.start() - 50)
                        end = min(len(text), match.end() + 50)
                        evidence = text[start:end].strip()
                        if start > 0:
                            evidence = "..." + evidence
                        if end < len(text):
                            evidence = evidence + "..."

                        detected.append(DetectedBlindSpot(
                            spot_type=pattern_data["type"],
                            category=pattern_data["category"],
                            confidence=0.7,  # –ë–∞–∑–æ–≤–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                            evidence=evidence,
                            pattern_description=pattern_data["description"],
                            gentle_question=pattern_data["question"]
                        ))
                        break  # –û–¥–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

        # –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        seen_categories = set()
        unique_detected = []
        for spot in detected:
            key = (spot.spot_type, spot.category)
            if key not in seen_categories:
                seen_categories.add(key)
                unique_detected.append(spot)

        if unique_detected:
            logger.debug(f"üîç Detected {len(unique_detected)} blind spots: {[s.spot_type for s in unique_detected]}")

        return unique_detected

    def get_exploration_prompt(
        self,
        spots: List[DetectedBlindSpot],
        alliance_level: float = 0.5
    ) -> Optional[str]:
        """
        –ü–æ–ª—É—á–∏—Ç—å –º—è–≥–∫–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Å–ª–µ–ø–æ–π –∑–æ–Ω—ã

        –í–ê–ñ–ù–û: –¢–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–æ–≤–µ—Ä–∏—è (alliance > 0.7)

        Args:
            spots: –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã
            alliance_level: –£—Ä–æ–≤–µ–Ω—å —Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–ª—å—è–Ω—Å–∞ (0.0 - 1.0)

        Returns:
            –ú—è–≥–∫–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ None –µ—Å–ª–∏ —Ä–∞–Ω–æ
        """
        if not spots:
            return None

        # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –∞–ª—å—è–Ω—Å–µ
        if alliance_level < 0.7:
            logger.debug(f"Alliance level {alliance_level} too low for blind spot exploration")
            return None

        # –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ —É–≤–µ—Ä–µ–Ω–Ω—É—é —Å–ª–µ–ø—É—é –∑–æ–Ω—É
        best_spot = max(spots, key=lambda x: x.confidence)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –º—è–≥–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        return f"üí≠ {best_spot.gentle_question}"

    def format_for_storage(self, spots: List[DetectedBlindSpot]) -> List[Dict[str, Any]]:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î/Qdrant
        """
        return [
            {
                "spot_type": spot.spot_type,
                "category": spot.category,
                "confidence": spot.confidence,
                "evidence": spot.evidence,
                "pattern_description": spot.pattern_description,
                "gentle_question": spot.gentle_question
            }
            for spot in spots
        ]

    def format_for_embedding(self, spots: List[DetectedBlindSpot]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–ø—ã–µ –∑–æ–Ω—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è embedding
        """
        if not spots:
            return ""

        parts = []
        for spot in spots:
            parts.append(f"{spot.spot_type}: {spot.pattern_description}")

        return ". ".join(parts)


# Singleton instance
_blind_spot_detector = None


def get_blind_spot_detector() -> BlindSpotDetector:
    """–ü–æ–ª—É—á–∏—Ç—å singleton —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ —Å–ª–µ–ø—ã—Ö –∑–æ–Ω"""
    global _blind_spot_detector
    if _blind_spot_detector is None:
        _blind_spot_detector = BlindSpotDetector()
    return _blind_spot_detector


# === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ===
if __name__ == "__main__":
    detector = BlindSpotDetector()

    test_texts = [
        # –ò–∑–±–µ–≥–∞–Ω–∏–µ —ç–º–æ—Ü–∏–π
        "–ù–µ –∑–Ω–∞—é, —á—Ç–æ —á—É–≤—Å—Ç–≤—É—é –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É. –≠—Ç–æ –Ω–µ–≤–∞–∂–Ω–æ, –¥–∞–≤–∞–π—Ç–µ –æ –¥—Ä—É–≥–æ–º.",

        # –ò–∑–±–µ–≥–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
        "–Ø —Å–ø—Ä–∞–≤–ª—é—Å—å —Å–∞–º–∞, –º–Ω–µ –Ω–∏–∫—Ç–æ –Ω–µ –Ω—É–∂–µ–Ω. –ü–æ–º–æ—â—å –Ω–∏ –∫ —á–µ–º—É.",

        # –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ —Å–ª–æ–≤–æ-–¥–µ–ª–æ
        "–•–æ—á—É –∑–∞–Ω–∏–º–∞—Ç—å—Å—è —Å–ø–æ—Ä—Ç–æ–º, –Ω–æ –Ω–µ –¥–µ–ª–∞—é. –ó–Ω–∞—é, —á—Ç–æ –Ω—É–∂–Ω–æ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è.",

        # –†–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è
        "–≠—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–∞–º–æ –∏–∑-–∑–∞ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤. –ï—Å–ª–∏ –±—ã –Ω–µ —Ä–∞–±–æ—Ç–∞, —Ç–æ –±—ã –≤—Å—ë –±—ã–ª–æ –∏–Ω–∞—á–µ.",

        # –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö
        "–ê –≤–æ—Ç –æ–Ω–∏ –¥–µ–ª–∞—é—Ç –µ—â—ë —Ö—É–∂–µ! –í—Å–µ —Ç–∞–∫ –∂–∏–≤—É—Ç, –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö.",

        # –Æ–º–æ—Ä –∫–∞–∫ –∑–∞—â–∏—Ç–∞
        "–ù—É –ø–æ–¥—É–º–∞–µ—à—å, –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å üòÇ –•–∞—Ö–∞—Ö–∞, —ç—Ç–æ –º–µ–ª–æ—á–∏!",

        # –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è
        "–û–±—ä–µ–∫—Ç–∏–≤–Ω–æ –≥–æ–≤–æ—Ä—è, —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ —ç—Ç–æ –ø–æ–Ω—è—Ç–Ω–æ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏ –æ–±—ä—è—Å–Ω–∏–º–æ."
    ]

    print("üîç BLIND SPOT DETECTOR TEST\n" + "=" * 50)

    for text in test_texts:
        print(f"\nüìù Text: {text[:80]}...")
        spots = detector.detect(text)

        if spots:
            for spot in spots:
                print(f"   ‚ö†Ô∏è {spot.spot_type} ({spot.category})")
                print(f"      {spot.pattern_description}")
                print(f"      ‚ùì {spot.gentle_question}")
        else:
            print("   ‚úÖ No blind spots detected")

    print("\n" + "=" * 50)
    print("‚úÖ Test completed!")
