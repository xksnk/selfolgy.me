"""
Deep Question Generator - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–æ—â–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è AI-–∫–æ—É—á–∞

–≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–¥—É—Ç –∫ –≥–ª—É–±–æ–∫–∏–º –∏–Ω—Å–∞–π—Ç–∞–º –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.
"""

from typing import List, Dict, Any, Optional
from datetime import datetime
import logging

logger = logging.getLogger(__name__)


class DeepQuestionGenerator:
    """
    –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–æ—â–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–æ—É—á–∏–Ω–≥–∞

    –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
    1. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏—Å—Ç–∏–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π
    2. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
    3. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏
    4. –í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è—Ö
    5. –í–æ–ø—Ä–æ—Å—ã –æ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏
    6. –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–æ—Å—Ç–∞
    """

    def __init__(self):
        self.question_templates = self._initialize_templates()

    def generate_questions(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any],
        count: int = 2
    ) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–æ—â–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

        Args:
            user_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ª–∏—á–Ω–æ—Å—Ç—å, –∏—Å—Ç–æ—Ä–∏—è)
            message_context: –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            count: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤

        Returns:
            List –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –º–æ—â–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        """
        questions = []

        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–π
        if message_context.get('contradictions_detected'):
            q = self._generate_contradiction_question(user_context, message_context)
            if q:
                questions.append(q)

        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        if message_context.get('recurring_pattern'):
            q = self._generate_pattern_question(user_context, message_context)
            if q:
                questions.append(q)

        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
        if message_context.get('resistance_detected'):
            q = self._generate_resistance_question(user_context, message_context)
            if q:
                questions.append(q)

        # 4. –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤)
        if len(questions) < count:
            questions.extend(
                self._generate_deepening_questions(user_context, message_context, count - len(questions))
            )

        # 5. –í–æ–ø—Ä–æ—Å—ã –æ –∂–µ–ª–∞–Ω–∏—è—Ö –∏ —Ü–µ–ª—è—Ö
        if message_context.get('goal_related') and len(questions) < count:
            q = self._generate_desire_question(user_context, message_context)
            if q:
                questions.append(q)

        return questions[:count]

    def _generate_contradiction_question(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any]
    ) -> Optional[str]:
        """–í–æ–ø—Ä–æ—Å—ã –æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è—Ö –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏"""

        stated_desire = message_context.get('stated_desire', '–∏–∑–º–µ–Ω–µ–Ω–∏—è')
        actual_behavior = message_context.get('actual_behavior', '—Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å-–∫–≤–æ')

        templates = [
            f"–Ø –∑–∞–º–µ—Ç–∏–ª –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ: –≤—ã –≥–æ–≤–æ—Ä–∏—Ç–µ –æ –∂–µ–ª–∞–Ω–∏–∏ {stated_desire}, "
            f"–Ω–æ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ {actual_behavior}. "
            f"–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –º–µ–∂–¥—É –∂–µ–ª–∞–Ω–∏–µ–º –∏ –¥–µ–π—Å—Ç–≤–∏–µ–º?",

            f"–í–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –∫–∞–∫–∞—è-—Ç–æ –≤–∞–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞, –ø–æ—á–µ–º—É —á–∞—Å—Ç—å –≤–∞—Å —Ö–æ—á–µ—Ç {stated_desire}, "
            f"–∞ –¥—Ä—É–≥–∞—è —á–∞—Å—Ç—å –≤—ã–±–∏—Ä–∞–µ—Ç {actual_behavior}? –ö–∞–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —ç—Ç–æ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–∏?",

            f"–ß—Ç–æ –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ - –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞, –∞ —Ü–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è? "
            f"–û –∫–∞–∫–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –æ–Ω–æ –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å?"
        ]

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏
        big_five = user_context.get('personality_profile', {}).get('traits', {}).get('big_five', {})
        openness = big_five.get('openness', 0.5)

        if openness > 0.7:
            # –î–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö - –±–æ–ª–µ–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å
            return templates[2]
        else:
            # –î–ª—è –º–µ–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç—ã—Ö - –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π
            return templates[0]

    def _generate_pattern_question(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any]
    ) -> Optional[str]:
        """–í–æ–ø—Ä–æ—Å—ã –æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö"""

        pattern_description = message_context.get('pattern_description', '—ç—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏—è')
        pattern_dates = message_context.get('pattern_dates', '—Ä–∞–Ω—å—à–µ')

        templates = [
            f"–≠—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ {pattern_dates}. "
            f"–ï—Å–ª–∏ –±—ã —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –±—ã–ª —É—á–∏—Ç–µ–ª–µ–º, —á–µ–º—É –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∞—Å –Ω–∞—É—á–∏—Ç—å?",

            f"–í—ã –∑–∞–º–µ—á–∞–ª–∏, —á—Ç–æ {pattern_description} –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è? "
            f"–ö–∞–∫–∞—è —á–∞—Å—Ç—å –≤–∞—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é, –∏ –∑–∞—á–µ–º?",

            f"–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –º–æ–º–µ–Ω—Ç: {pattern_description} –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. "
            f"–ß—Ç–æ —Å—Ç–∞–Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–º –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏, –∫–æ–≥–¥–∞ –≤—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ—Å—å –æ—Ç —ç—Ç–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞?",

            f"–ö–∞–∫—É—é –≤–∞–∂–Ω—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω? "
            f"–ò –∫–∞–∫ –µ—â–µ –º–æ–∂–Ω–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç—å —ç—Ç—É –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å?",
        ]

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        current_mood = user_context.get('current_mood', 'neutral')

        if current_mood == 'negative':
            # –ë–æ–ª–µ–µ –º—è–≥–∫–∏–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏
            return templates[0]  # –£—á–∏—Ç–µ–ª—å - –º–µ–Ω–µ–µ –≤—ã–∑—ã–≤–∞—é—â–∏–π –æ–±—Ä–∞–∑
        else:
            # –ú–æ–∂–Ω–æ –±—ã—Ç—å –±–æ–ª–µ–µ direct
            return templates[1]

    def _generate_resistance_question(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any]
    ) -> Optional[str]:
        """–í–æ–ø—Ä–æ—Å—ã –æ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–∏ –∏ —Å—Ç—Ä–∞—Ö–∞—Ö"""

        resistance_topic = message_context.get('resistance_topic', '—ç—Ç–æ–≥–æ')

        templates = [
            f"–ö–æ–≥–¥–∞ –≤—ã –¥—É–º–∞–µ—Ç–µ –æ {resistance_topic}, —á—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –º–æ–≥–ª–æ –±—ã –ø—Ä–æ–∏–∑–æ–π—Ç–∏? "
            f"–ò —á—Ç–æ —Å–∞–º–æ–µ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ?",

            f"–ß–∞—Å—Ç—å –≤–∞—Å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—Ç—Å—è {resistance_topic}. "
            f"–ï—Å–ª–∏ –±—ã –≤—ã –º–æ–≥–ª–∏ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —ç—Ç–æ–π —á–∞—Å—Ç—å—é - —á—Ç–æ –æ–Ω–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å?",

            f"–ß—Ç–æ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ, –µ—Å–ª–∏ —Å–¥–µ–ª–∞–µ—Ç–µ —à–∞–≥ –∫ {resistance_topic}? "
            f"–ò —á—Ç–æ –æ–±—Ä–µ—Ç–∞–µ—Ç–µ?",

            f"–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ —á–µ—Ä–µ–∑ {resistance_topic} –∏ –æ–≥–ª—è–¥—ã–≤–∞–µ—Ç–µ—Å—å –Ω–∞–∑–∞–¥. "
            f"–ß—Ç–æ –±—ã –≤—ã —Å–∫–∞–∑–∞–ª–∏ —Å–µ–±–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º—É?"
        ]

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è
        trust_level = user_context.get('trust_level', 0.5)

        if trust_level < 0.5:
            # –ù–∏–∑–∫–æ–µ –¥–æ–≤–µ—Ä–∏–µ - –º—è–≥—á–µ
            return templates[3]  # –ë—É–¥—É—â–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ
        elif trust_level > 0.7:
            # –í—ã—Å–æ–∫–æ–µ –¥–æ–≤–µ—Ä–∏–µ - –º–æ–∂–µ–º –±—ã—Ç—å direct
            return templates[1]  # Work —Å —á–∞—Å—Ç—è–º–∏ –ª–∏—á–Ω–æ—Å—Ç–∏
        else:
            return templates[0]

    def _generate_deepening_questions(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any],
        count: int
    ) -> List[str]:
        """–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç–∏ - –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ domain"""

        # üî• FIX: –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥ domain –∏ intent
        domain = message_context.get('domain', 'general')
        intent = message_context.get('intent', 'general_conversation')
        goal_related = message_context.get('goal_related', False)

        # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ë–ò–ó–ù–ï–°–ê / –†–ê–ë–û–¢–´ / –¶–ï–õ–ï–ô
        if domain == 'work' or goal_related or intent == 'advice_request':
            templates = [
                "–ö–∞–∫–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å?",
                "–ß—Ç–æ –±—É–¥–µ—Ç –¥–ª—è –≤–∞—Å –º–∞—Ä–∫–µ—Ä–æ–º —É—Å–ø–µ—Ö–∞ –≤ —ç—Ç–æ–º?",
                "–ö–∞–∫–∏–µ —Ä–µ—Å—É—Ä—Å—ã —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –≤–ø–µ—Ä–µ–¥?",
                "–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —á–µ—Ä–µ–∑ –ø–æ–ª–≥–æ–¥–∞, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è?",
                "–ö–∞–∫–æ–π –ø–µ—Ä–≤—ã–π –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —É–∂–µ —Å–µ–≥–æ–¥–Ω—è?",
            ]
        # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –û–¢–ù–û–®–ï–ù–ò–ô
        elif domain == 'relationships':
            templates = [
                "–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ —ç—Ç–∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö?",
                "–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –¥—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —Å–µ–±—è —Ä—è–¥–æ–º —Å –≤–∞–º–∏?",
                "–ß—Ç–æ –≤—ã –≥–æ—Ç–æ–≤—ã –∏–∑–º–µ–Ω–∏—Ç—å –≤ —Å–≤–æ–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–∏?",
                "–ö–∞–∫—É—é –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç —ç—Ç–∞ –¥–∏–Ω–∞–º–∏–∫–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π?",
            ]
        # –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≠–ú–û–¶–ò–ô (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –≥–ª—É–±–æ–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã)
        elif domain == 'emotions':
            templates = [
                "–ß—Ç–æ –µ—â–µ –∑–¥–µ—Å—å –µ—Å—Ç—å?",
                "–ï—Å–ª–∏ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ, —á—Ç–æ –∑–∞ –Ω–∏–º?",
                "–ö–∞–∫–∞—è —á–∞—Å—Ç—å –≤–∞—Å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª—è–µ—Ç—Å—è, –∏ —á–µ–≥–æ –æ–Ω–∞ –±–æ–∏—Ç—Å—è?",
                "–ß—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–º, –∫–æ–≥–¥–∞ –≤—ã –ø–æ–∑–≤–æ–ª—è–µ—Ç–µ —Å–µ–±–µ —ç—Ç–æ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å?",
            ]
        # –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        else:
            templates = [
                "–ß—Ç–æ –µ—â–µ –∑–¥–µ—Å—å –µ—Å—Ç—å?",
                "–ß—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–º, –∫–æ–≥–¥–∞ –≤—ã –ø–æ–∑–≤–æ–ª—è–µ—Ç–µ —Å–µ–±–µ —É–≤–∏–¥–µ—Ç—å —ç—Ç–æ?",
                "–ï—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç –≤–∞—à–µ–π –º—É–¥—Ä–æ–π —á–∞—Å—Ç–∏, —á—Ç–æ –±—ã –æ–Ω–æ –≥–æ–≤–æ—Ä–∏–ª–æ?",
            ]

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏
        big_five = user_context.get('personality_profile', {}).get('traits', {}).get('big_five', {})
        openness = big_five.get('openness', 0.5)
        neuroticism = big_five.get('neuroticism', 0.5)

        selected = []

        # –î–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö - –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–ù–û –ù–ï –¥–ª—è –±–∏–∑–Ω–µ—Å–∞!)
        if openness > 0.7 and domain != 'work' and intent != 'advice_request':
            selected.append("–ï—Å–ª–∏ –±—ã —ç—Ç–æ –±—ã–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ—Ç –≤–∞—à–µ–π –º—É–¥—Ä–æ–π —á–∞—Å—Ç–∏, —á—Ç–æ –±—ã –æ–Ω–æ –≥–æ–≤–æ—Ä–∏–ª–æ?")

        # –î–ª—è —Ç—Ä–µ–≤–æ–∂–Ω—ã—Ö - –∑–∞–∑–µ–º–ª—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
        if neuroticism > 0.6:
            if domain == 'work' or intent == 'advice_request':
                selected.append("–ß—Ç–æ —É –≤–∞—Å —É–∂–µ –ø–æ–ª—É—á–∞–ª–æ—Å—å —Ä–∞–Ω—å—à–µ –≤ –ø–æ—Ö–æ–∂–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö?")
            else:
                selected.append("–ß—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–º, –∫–æ–≥–¥–∞ –≤—ã —ç—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç–µ?")

        # –î–æ–±–∞–≤–ª—è–µ–º domain-specific –≤–æ–ø—Ä–æ—Å—ã
        if len(selected) < count:
            remaining = count - len(selected)
            selected.extend(templates[:remaining])

        return selected[:count]

    def _generate_desire_question(
        self,
        user_context: Dict[str, Any],
        message_context: Dict[str, Any]
    ) -> Optional[str]:
        """–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∏—Å—Ç–∏–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π"""

        templates = [
            "–ï—Å–ª–∏ –±—ã –Ω–µ –±—ã–ª–æ –Ω–∏–∫–∞–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π - –Ω–∏ –¥–µ–Ω–µ–≥, –Ω–∏ –º–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö, –Ω–∏ —Å—Ç—Ä–∞—Ö–æ–≤ - —á—Ç–æ –±—ã –≤—ã –¥–µ–ª–∞–ª–∏?",
            "–ö–∞–∫–∞—è –∂–∏–∑–Ω—å –∑–∞—Å—Ç–∞–≤–∏–ª–∞ –±—ã –≤–∞—Å –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è —Å –ø—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–µ–º?",
            "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ —Ç–∞–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, —á—Ç–æ –¥–∞–∂–µ –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç–µ —ç—Ç–æ–≥–æ –∫–∞–∫ —Ç–∞–ª–∞–Ω—Ç?",
            "–í –∫–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–±—è –Ω–∞–∏–±–æ–ª–µ–µ —Å–æ–±–æ–π?",
            "–ß–µ–º –±—ã –≤—ã –∑–∞–Ω–∏–º–∞–ª–∏—Å—å, –µ—Å–ª–∏ –±—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–ª–∏, —á—Ç–æ –Ω–µ –ø—Ä–æ–≤–∞–ª–∏—Ç–µ—Å—å?",
        ]

        # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø–æ–¥ —Å—Ç–∞–¥–∏—é —Ä–∞–∑–≤–∏—Ç–∏—è
        personality_profile = user_context.get('personality_profile', {})

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è —Ä–æ—Å—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Ç–∞–ª–∞–Ω—Ç—ã
        if personality_profile.get('trajectory_insights'):
            return templates[2]

        # –ï—Å–ª–∏ –≤—ã—Å–æ–∫–∞—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å - –≤–æ–ø—Ä–æ—Å –ø—Ä–æ —Å—Ç—Ä–∞—Ö –ø—Ä–æ–≤–∞–ª–∞
        big_five = personality_profile.get('traits', {}).get('big_five', {})
        if big_five.get('neuroticism', 0) > 0.6:
            return templates[4]

        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤–æ–ø—Ä–æ—Å
        return templates[0]

    def generate_follow_up_question(
        self,
        user_answer: str,
        original_question: str,
        user_context: Dict[str, Any]
    ) -> Optional[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç follow-up –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –º–æ—â–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞.
        """

        # –î–µ—Ç–µ–∫—Ç–∏–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤ –æ—Ç–≤–µ—Ç–µ
        answer_lower = user_answer.lower()

        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø–æ–º–∏–Ω–∞–µ—Ç —Å—Ç—Ä–∞—Ö
        if any(word in answer_lower for word in ['–±–æ—é—Å—å', '—Å—Ç—Ä–∞—à–Ω–æ', '—Å—Ç—Ä–∞—Ö', '–æ–ø–∞—Å–∞—é—Å—å']):
            return "–ß—Ç–æ –µ—Å–ª–∏ –±—ã —ç—Ç–æ—Ç —Å—Ç—Ä–∞—Ö –±—ã–ª –≥–æ–ª–æ—Å–æ–º —á–∞—Å—Ç–∏ –≤–∞—Å, –∫–æ—Ç–æ—Ä–∞—è –æ—á–µ–Ω—å –≤–∞—Å –ª—é–±–∏—Ç –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å? –ß—Ç–æ –æ–Ω–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å?"

        # –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π
        if any(word in answer_lower for word in ['–ª—é–¥–∏', '–æ–Ω–∏', '—Ä–æ–¥–∏—Ç–µ–ª–∏', '–¥—Ä—É–∑—å—è', '–ø–∞—Ä—Ç–Ω–µ—Ä']):
            return "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ –≤—ã —É–ø–æ–º—è–Ω—É–ª–∏ –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π. –ê –µ—Å–ª–∏ —É–±—Ä–∞—Ç—å –∏—Ö –º–Ω–µ–Ω–∏—è - —á—Ç–æ –±—ã —Å–∫–∞–∑–∞–ª —Ç–æ–ª—å–∫–æ –≤–∞—à –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≥–æ–ª–æ—Å?"

        # –ï—Å–ª–∏ –¥–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç (–∫–æ—Ä–æ—Ç–∫–∏–π)
        if len(user_answer) < 50:
            return "–ß—Ç–æ –µ—â–µ —Ç–∞–º –µ—Å—Ç—å? –ü–æ–∑–≤–æ–ª—å—Ç–µ —Å–µ–±–µ —É–≥–ª—É–±–∏—Ç—å—Å—è..."

        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–ª–∏–Ω–Ω—ã–π –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–π - –ø–æ—Ö–≤–∞–ª–∏—Ç—å –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å
        if len(user_answer) > 200:
            return "–≠—Ç–æ –≥–ª—É–±–æ–∫–æ–µ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ. –ß—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è –≤ –≤–∞—Å, –∫–æ–≥–¥–∞ –≤—ã —ç—Ç–æ –≤–∏–¥–∏—Ç–µ —Ç–∞–∫ —è—Å–Ω–æ?"

        # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - —É–≥–ª—É–±–ª—è–µ–º
        return "–ï—Å–ª–∏ –∏–¥—Ç–∏ –µ—â–µ –≥–ª—É–±–∂–µ –≤ —ç—Ç–æ –æ—â—É—â–µ–Ω–∏–µ - —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è?"

    def _initialize_templates(self) -> Dict[str, List[str]]:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —à–∞–±–ª–æ–Ω–æ–≤ –≤–æ–ø—Ä–æ—Å–æ–≤"""

        return {
            'contradictions': [
                "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –º–µ–∂–¥—É –∂–µ–ª–∞–Ω–∏–µ–º –∏ –¥–µ–π—Å—Ç–≤–∏–µ–º?",
                "–ö–∞–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —ç—Ç–æ–º –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–∏?",
                "–û –∫–∞–∫–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ —ç—Ç–æ –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å?",
            ],
            'patterns': [
                "–ï—Å–ª–∏ –±—ã —ç—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –±—ã–ª —É—á–∏—Ç–µ–ª–µ–º, —á–µ–º—É –æ–Ω –ø—ã—Ç–∞–µ—Ç—Å—è –≤–∞—Å –Ω–∞—É—á–∏—Ç—å?",
                "–ö–∞–∫–∞—è —á–∞—Å—Ç—å –≤–∞—Å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é?",
                "–ß—Ç–æ —Å—Ç–∞–Ω–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–º, –∫–æ–≥–¥–∞ –≤—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç–µ—Å—å –æ—Ç —ç—Ç–æ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞?",
            ],
            'resistance': [
                "–ß—Ç–æ —Å–∞–º–æ–µ —Å—Ç—Ä–∞—à–Ω–æ–µ –º–æ–≥–ª–æ –±—ã –ø—Ä–æ–∏–∑–æ–π—Ç–∏? –ò —á—Ç–æ —Å–∞–º–æ–µ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–µ?",
                "–ß—Ç–æ —ç—Ç–∞ —á–∞—Å—Ç—å –≤–∞—Å –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∏—Ç—å?",
                "–ß—Ç–æ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ –∏ —á—Ç–æ –æ–±—Ä–µ—Ç–∞–µ—Ç–µ?",
            ],
            'desires': [
                "–ï—Å–ª–∏ –±—ã –Ω–µ –±—ã–ª–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π - —á—Ç–æ –±—ã –≤—ã –¥–µ–ª–∞–ª–∏?",
                "–ö–∞–∫–∞—è –∂–∏–∑–Ω—å –∑–∞—Å—Ç–∞–≤–∏–ª–∞ –±—ã –≤–∞—Å –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è —Å –ø—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–µ–º?",
                "–í –∫–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ —Å–µ–±—è –Ω–∞–∏–±–æ–ª–µ–µ —Å–æ–±–æ–π?",
            ],
            'deepening': [
                "–ß—Ç–æ –µ—â–µ –∑–¥–µ—Å—å –µ—Å—Ç—å?",
                "–ß—Ç–æ –∑–∞ —ç—Ç–∏–º —á—É–≤—Å—Ç–≤–æ–º?",
                "–ß—Ç–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω—ã–º?",
            ]
        }


# === –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø ===

if __name__ == "__main__":
    # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_context = {
        'personality_profile': {
            'traits': {
                'big_five': {
                    'openness': 0.85,
                    'conscientiousness': 0.72,
                    'extraversion': 0.68,
                    'agreeableness': 0.79,
                    'neuroticism': 0.34
                }
            },
            'trajectory_insights': {
                'trends': {
                    'openness': {'change': 0.25, 'direction': 'growing'}
                }
            }
        },
        'current_mood': 'neutral',
        'trust_level': 0.7
    }

    # –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    message_context = {
        'contradictions_detected': True,
        'stated_desire': '–Ω–∞–π—Ç–∏ –ª—é–±–∏–º—É—é —Ä–∞–±–æ—Ç—É',
        'actual_behavior': '–æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏',
        'recurring_pattern': True,
        'pattern_description': '–Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–æ–π',
        'pattern_dates': '3 –º–µ—Å—è—Ü–∞ –Ω–∞–∑–∞–¥ –∏ 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥'
    }

    # –°–æ–∑–¥–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
    generator = DeepQuestionGenerator()

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã
    questions = generator.generate_questions(user_context, message_context, count=2)

    print("=== –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –ú–û–©–ù–´–ï –í–û–ü–†–û–°–´ ===\n")
    for i, q in enumerate(questions, 1):
        print(f"{i}. {q}\n")

    # –ü—Ä–∏–º–µ—Ä follow-up
    user_answer = "–ë–æ—é—Å—å —á—Ç–æ –µ—Å–ª–∏ —É–π–¥—É —Å —Ç–µ–∫—É—â–µ–π —Ä–∞–±–æ—Ç—ã, —Ç–æ –Ω–µ —Å–º–æ–≥—É –Ω–∞–π—Ç–∏ –Ω–∏—á–µ–≥–æ –ª—É—á—à–µ–≥–æ"
    follow_up = generator.generate_follow_up_question(
        user_answer,
        questions[0],
        user_context
    )

    print(f"=== FOLLOW-UP –í–û–ü–†–û–° ===\n{follow_up}")
