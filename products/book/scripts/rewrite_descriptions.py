#!/usr/bin/env python3
"""
–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ Claude.

–î–µ–ª–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python rewrite_descriptions.py --dry-run    # –ü–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è
    python rewrite_descriptions.py --apply      # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
"""

import json
import argparse
from pathlib import Path
from datetime import datetime
import os
import sys

PROJECT_ROOT = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from dotenv import load_dotenv
load_dotenv(PROJECT_ROOT / ".env")

import anthropic

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

DATA_DIR = PROJECT_ROOT / "intelligent_question_core/data"
V2_FILE = DATA_DIR / "selfology_programs_v2.json"
MODEL = "claude-sonnet-4-20250514"

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ü–†–û–ú–ü–¢
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

SYSTEM_PROMPT = """–¢—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–Ω–∏–≥–∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–∏—Ç–∞—Ç–µ–ª—è.

–ö–û–ù–¢–ï–ö–°–¢:
–ö–Ω–∏–≥–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º (—Ç–µ–º—ã: –æ—Ç–Ω–æ—à–µ–Ω–∏—è, –∫–∞—Ä—å–µ—Ä–∞, —Å—Ç—Ä–∞—Ö–∏...) –∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ (—Ä–∞–∑–¥–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã).
–£ –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞ –µ—Å—Ç—å –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞ —á–∏—Ç–∞—Ç–µ–ª—é "–æ —á—ë–º —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª".

–ü–†–ò–ù–¶–ò–ü–´ –•–û–†–û–®–ï–ì–û –û–ü–ò–°–ê–ù–ò–Ø:
1. –ú–∞–∫—Å–∏–º—É–º 4-5 —Å–ª–æ–≤
2. –ë–µ–∑ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞ –∏ —Ç–µ—Ä–º–∏–Ω–æ–≤
3. –ü–æ–Ω—è—Ç–Ω–æ –ë–ï–ó –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã
4. –ö–∞–∫ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≥–ª—è–Ω—Ü–µ–≤–æ–º –∂—É—Ä–Ω–∞–ª–µ
5. –ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Å "—á—Ç–æ/–∫—Ç–æ/–≥–¥–µ/–∫–∞–∫/–∫—É–¥–∞/–º–æ–∏"
6. –¢—ë–ø–ª—ã–π, –ø—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π —Ç–æ–Ω

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–ü–ò–°–ê–ù–ò–ô:
- "–≥–¥–µ —è —Å–µ–π—á–∞—Å" (–≤–º–µ—Å—Ç–æ "–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è")
- "–ª—é–¥–∏ –≤–æ–∫—Ä—É–≥ –º–µ–Ω—è" (–≤–º–µ—Å—Ç–æ "—ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≤–ª–∏—è–Ω–∏–π")
- "—á–µ–≥–æ —Ö–æ—á—É –∏ –±–æ—é—Å—å" (–≤–º–µ—Å—Ç–æ "–ø–æ–ª—é—Å–∞ –º–æ–µ–≥–æ —è")
- "—á—Ç–æ —Ç–µ–ª–æ –ø–æ–º–Ω–∏—Ç" (–≤–º–µ—Å—Ç–æ "—Ç–µ–ª–µ—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è")
- "–ø–µ—Ä–≤—ã–π —à–∞–≥" (–≤–º–µ—Å—Ç–æ "–ø–µ—Ä–≤—ã–π –∫–∏—Ç")
- "–º–æ–∏ –¥–µ–Ω—å–≥–∏ —Å–µ–≥–æ–¥–Ω—è" (–≤–º–µ—Å—Ç–æ "—Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ")

–ü–†–ò–ú–ï–†–´ –ü–õ–û–•–ò–• –û–ü–ò–°–ê–ù–ò–ô:
- "—ç–∫–æ—Å–∏—Å—Ç–µ–º–∞ –≤–ª–∏—è–Ω–∏–π" ‚Äî –∂–∞—Ä–≥–æ–Ω, –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ
- "—Ç–µ–ª–µ—Å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" ‚Äî —Ç–µ—Ä–º–∏–Ω –∏–∑ –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–∏–∏
- "–ø–µ—Ä–µ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏" ‚Äî —Å–ª–∏—à–∫–æ–º –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ
- "–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ —Ü–∏–∫–ª—ã" ‚Äî –∂–∞—Ä–≥–æ–Ω
- "–∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å" ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ—â–µ

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –Ω–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞."""

USER_TEMPLATE = """–ü—Ä–æ–≥—Ä–∞–º–º–∞: "{program}"
–ö–ª–∞—Å—Ç–µ—Ä: "{cluster}"
–¢–µ–∫—É—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: "{description}"

–ù–∞–ø–∏—à–∏ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (4-5 —Å–ª–æ–≤, –ø–æ–Ω—è—Ç–Ω–æ –æ–±—ã—á–Ω–æ–º—É —á–µ–ª–æ–≤–µ–∫—É):"""


# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –û–°–ù–û–í–ù–û–ô –ö–û–î
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

def load_data():
    with open(V2_FILE, encoding="utf-8") as f:
        return json.load(f)


def get_unique_descriptions(data):
    """–°–æ–±—Ä–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
    descriptions = {}

    for prog in data["programs"]:
        for block in prog["blocks"]:
            desc = block.get("description", "")
            if desc and desc not in descriptions:
                descriptions[desc] = {
                    "program": prog["name"],
                    "cluster": block["name"],
                    "original": desc
                }

    return descriptions


def rewrite_description(client, program: str, cluster: str, description: str) -> str:
    """–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–¥–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Claude"""
    try:
        message = client.messages.create(
            model=MODEL,
            max_tokens=100,
            system=SYSTEM_PROMPT,
            messages=[{
                "role": "user",
                "content": USER_TEMPLATE.format(
                    program=program,
                    cluster=cluster,
                    description=description
                )
            }]
        )
        return message.content[0].text.strip().strip('"').strip("'")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return description


def main():
    parser = argparse.ArgumentParser(description="–ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ–ø–∏—Å–∞–Ω–∏–π –∫–ª–∞—Å—Ç–µ—Ä–æ–≤")
    parser.add_argument("--dry-run", action="store_true", help="–¢–æ–ª—å–∫–æ –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è")
    parser.add_argument("--apply", action="store_true", help="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É")
    parser.add_argument("--sample", type=int, help="–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–¥–ª—è —Ç–µ—Å—Ç–∞)")
    args = parser.parse_args()

    client = anthropic.Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

    print("üìö –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã...")
    data = load_data()

    print("üîç –ü–æ–∏—Å–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π...")
    descriptions = get_unique_descriptions(data)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(descriptions)}")

    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
    if args.sample:
        descriptions = dict(list(descriptions.items())[:args.sample])
        print(f"   –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: {len(descriptions)} –æ–ø–∏—Å–∞–Ω–∏–π")

    # –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞
    print("\n" + "‚ïê" * 60)
    print("‚úèÔ∏è  –ü–ï–†–ï–§–û–†–ú–£–õ–ò–†–û–í–ö–ê –û–ü–ò–°–ê–ù–ò–ô")
    print("‚ïê" * 60 + "\n")

    rewrites = {}

    for i, (old_desc, context) in enumerate(descriptions.items(), 1):
        print(f"[{i}/{len(descriptions)}] {context['program']} ‚Üí {context['cluster']}")
        print(f"   –ë—ã–ª–æ:  \"{old_desc}\"")

        new_desc = rewrite_description(
            client,
            context["program"],
            context["cluster"],
            old_desc
        )

        rewrites[old_desc] = new_desc

        if new_desc != old_desc:
            print(f"   –°—Ç–∞–ª–æ: \"{new_desc}\" ‚úì")
        else:
            print(f"   –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
        print()

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    changed = sum(1 for old, new in rewrites.items() if old != new)
    print("‚îÄ" * 40)
    print(f"üìä –ò–∑–º–µ–Ω–µ–Ω–æ: {changed}/{len(rewrites)}")

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    results_file = DATA_DIR / f"descriptions_rewrite_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(results_file, "w", encoding="utf-8") as f:
        json.dump(rewrites, f, ensure_ascii=False, indent=2)
    print(f"üíæ –ú–∞–ø–ø–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {results_file.name}")

    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫ –±–∞–∑–µ
    if args.apply:
        print("\nüîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫ –±–∞–∑–µ...")

        # Backup
        backup_file = V2_FILE.with_suffix(f".backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json")
        with open(backup_file, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        print(f"   Backup: {backup_file.name}")

        # –ü—Ä–∏–º–µ–Ω—è–µ–º
        applied = 0
        for prog in data["programs"]:
            for block in prog["blocks"]:
                old_desc = block.get("description", "")
                if old_desc in rewrites and rewrites[old_desc] != old_desc:
                    block["description"] = rewrites[old_desc]
                    applied += 1

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        with open(V2_FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

        print(f"   ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π: {applied}")
    else:
        print("\n‚ö†Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–π --apply –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑—É")


if __name__ == "__main__":
    main()
